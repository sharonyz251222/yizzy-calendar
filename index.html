<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yizzy Planner - Global Backup (TW Holidays + Time/Deadline)</title>

    <link rel="icon" href="https://emojiapi.dev/api/v1/sparkles/64.png">
    <meta name="theme-color" content="#eab308">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Dancing+Script:wght@700&family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            transition: background-color 0.5s ease;
        }

        .accent-font { font-family: 'Dancing Script', cursive; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 80px; transition: all 0.3s ease; }
        .task-done { text-decoration: line-through; opacity: 0.5; }
        .dot { height: 4px; width: 4px; border-radius: 50%; }

        /* ‰∏ªÈ°åÈÖçËâ≤ */
        .theme-0 { --theme-bg: #fefce8; --theme-primary: #eab308; --theme-soft: #fef9c3; --theme-accent: #854d0e; }
        .theme-1 { --theme-bg: #f5f3ff; --theme-primary: #a78bfa; --theme-soft: #ede9fe; --theme-accent: #5b21b6; } 
        .theme-2 { --theme-bg: #ecfdf5; --theme-primary: #34d399; --theme-soft: #d1fae5; --theme-accent: #065f46; } 
        .theme-3 { --theme-bg: #fff7ed; --theme-primary: #fb923c; --theme-soft: #ffedd5; --theme-accent: #9a3412; } 
        .theme-4 { --theme-bg: #f0fdf4; --theme-primary: #4ade80; --theme-soft: #dcfce7; --theme-accent: #166534; } 
        .theme-5 { --theme-bg: #fdf2f8; --theme-primary: #f472b6; --theme-soft: #fce7f3; --theme-accent: #9d174d; } 
        .theme-6 { --theme-bg: #eff6ff; --theme-primary: #60a5fa; --theme-soft: #dbeafe; --theme-accent: #1e40af; } 
        .theme-7 { --theme-bg: #fffbeb; --theme-primary: #fbbf24; --theme-soft: #fef3c7; --theme-accent: #92400e; } 
        .theme-8 { --theme-bg: #fafaf9; --theme-primary: #a8a29e; --theme-soft: #f5f5f4; --theme-accent: #44403c; } 
        .theme-9 { --theme-bg: #fefce8; --theme-primary: #eab308; --theme-soft: #fef9c3; --theme-accent: #854d0e; } 
        .theme-10 { --theme-bg: #f0f9ff; --theme-primary: #38bdf8; --theme-soft: #e0f2fe; --theme-accent: #075985; } 
        .theme-11 { --theme-bg: #f5f5f4; --theme-primary: #78716c; --theme-soft: #e7e5e4; --theme-accent: #292524; } 

        .dynamic-bg { background-color: var(--theme-bg); }
        .dynamic-text { color: var(--theme-primary); }
        .dynamic-accent-text { color: var(--theme-accent); }
        .dynamic-btn { background-color: var(--theme-primary); }
        .dynamic-soft-bg { background-color: var(--theme-soft); }
        .dynamic-border { border-color: var(--theme-primary); }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .loading-overlay {
            position: fixed; inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex; align-items: center; justify-content: center;
            z-index: 100;
        }

        .task-preview-text {
            font-size: 9px;
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 2px;
            color: #64748b;
        }

        .holiday-text {
            font-size: 8px;
            color: #f43f5e;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body class="p-4 md:p-8 dynamic-bg min-h-screen">
    <div id="loading" class="loading-overlay">
        <div class="flex flex-col items-center gap-2">
            <div class="dynamic-text font-bold animate-pulse text-lg tracking-widest">Yizzy Planner</div>
            <div id="loadingStatus" class="text-xs text-gray-400">Ê≠£Âú®ÂòóË©¶ËàáÈõ≤Á´ØÂêåÊ≠•...</div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto space-y-6">
        <!-- È†ÇÈÉ®Ë≥áË®äÊ¨Ñ -->
        <div class="flex justify-between items-center mb-4 px-2">
            <div id="yearLabel" class="px-4 py-1 bg-white/50 backdrop-blur rounded-full text-xs font-black tracking-[0.3em] text-gray-400 shadow-sm border border-white/50">2026</div>
            
            <div class="flex gap-2">
                <button onclick="exportData()" title="ÂÖ®Á´ôÂÇô‰ªΩËàáÈÇÑÂéü" class="p-2 bg-white/80 backdrop-blur rounded-xl border border-white/50 shadow-sm hover:bg-white transition-all text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div class="inline-flex bg-white/80 backdrop-blur p-1 rounded-2xl shadow-sm border border-white/50">
                    <button onclick="switchView('calendar')" id="btnCal" class="px-6 py-2 rounded-xl text-xs font-bold transition-all dynamic-btn text-white shadow-md">Month</button>
                    <button onclick="switchView('week')" id="btnWeek" class="px-6 py-2 rounded-xl text-xs font-bold transition-all text-gray-400 hover:text-gray-600">Week</button>
                </div>
            </div>
        </div>

        <!-- Â∞éËà™ËàáË®àÊó•È°ØÁ§∫ -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-white/90 backdrop-blur p-5 rounded-3xl shadow-sm border border-white/50 gap-4">
            <div class="flex items-baseline gap-4">
                <h2 id="viewTitle" class="text-4xl font-bold tracking-tight text-gray-800 accent-font">January</h2>
                <div id="yearProgress" class="text-[10px] font-bold text-gray-400 bg-gray-50 px-3 py-1 rounded-full border border-gray-100">Day 1 / Remaining 364</div>
            </div>
            <div class="flex gap-3">
                <button onclick="navigate(-1)" class="p-2.5 hover:bg-gray-50 rounded-full transition border border-gray-100 text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button onclick="goToday()" class="px-5 py-1 text-sm font-bold border border-gray-100 rounded-full hover:bg-gray-50 text-gray-500 transition-all">Today</button>
                <button onclick="navigate(1)" class="p-2.5 hover:bg-gray-50 rounded-full transition border border-gray-100 text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>

        <!-- ÊúàÂ∫¶ÁÑ¶Èªû (Pending Tasks) -->
        <div id="monthlyFocusContainer" class="bg-white/40 backdrop-blur rounded-[2rem] p-6 border border-white/50 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                <div class="p-1.5 dynamic-btn rounded-lg">
                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
                <h3 class="text-xs font-black uppercase tracking-[0.2em] dynamic-accent-text">Monthly Focus (Pending)</h3>
            </div>
            <div id="monthlyFocusList" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2"></div>
        </div>

        <!-- ÊúàÊõÜË¶ñÂúñ -->
        <div id="calendarContainer" class="bg-white/80 backdrop-blur rounded-[2rem] shadow-xl p-6 border border-white/50">
            <div class="calendar-grid mb-4 border-b border-gray-50 pb-2">
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-gray-300">Mon</div>
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-gray-300">Tue</div>
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-gray-300">Wed</div>
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-gray-300">Thu</div>
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-gray-300">Fri</div>
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-red-300">Sat</div>
                <div class="text-center py-2 text-[10px] font-black uppercase tracking-widest text-red-300">Sun</div>
            </div>
            <div id="calendarDays" class="calendar-grid gap-2"></div>
        </div>

        <!-- ÈÄ±Ë¶ñÂúñ -->
        <div id="weekContainer" class="hidden flex flex-col gap-4 pb-12"></div>

        <!-- Á∑®ËºØÂΩàÁ™ó -->
        <div id="dayModal" class="fixed inset-0 bg-black/30 hidden z-50 flex items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden max-h-[90vh] flex flex-col border border-white">
                <div class="dynamic-btn p-7 text-white flex justify-between items-center">
                    <div>
                        <h3 id="modalDateTitle" class="text-xl font-bold">Date Title</h3>
                        <p id="modalDayOfWeek" class="text-xs opacity-80 font-bold uppercase tracking-widest mt-1"></p>
                    </div>
                    <button onclick="closeModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round"/></svg>
                    </button>
                </div>

                <div class="p-8 overflow-y-auto flex-1">
                    <div class="mb-8">
                        <h4 class="text-[10px] font-black text-gray-300 uppercase tracking-[0.2em] mb-4">Tasks (Click to Edit)</h4>
                        <ul id="modalTaskList" class="space-y-3"></ul>
                    </div>
                    <div class="mb-8">
                        <h4 class="text-[10px] font-black text-gray-300 uppercase tracking-[0.2em] mb-2">Notes</h4>
                        <textarea id="modalNote" rows="2" placeholder="Write something..." 
                                  class="w-full text-sm bg-gray-50 border-none rounded-2xl p-4 focus:ring-2 focus:ring-opacity-50 dynamic-border outline-none shadow-inner"></textarea>
                    </div>
                    <div class="dynamic-soft-bg p-5 rounded-[1.5rem] border border-white">
                        <h4 id="inputStatusLabel" class="text-[10px] font-black dynamic-text uppercase tracking-[0.2em] mb-3">Add Item</h4>
                        <div class="flex flex-col gap-3">
                            <input type="text" id="modalInput" placeholder="Task name..." 
                                   class="w-full bg-white border-none rounded-xl px-4 py-2.5 text-sm outline-none shadow-sm">
                            <div class="flex gap-2">
                                <div class="flex-1 flex flex-col gap-1">
                                    <label class="text-[9px] font-bold text-gray-400 pl-2">Time</label>
                                    <input type="time" id="modalTime" class="bg-white border-none rounded-xl px-3 py-2 text-xs outline-none shadow-sm">
                                </div>
                                <div class="flex-1 flex flex-col gap-1">
                                    <label class="text-[9px] font-bold text-gray-400 pl-2">Deadline</label>
                                    <input type="date" id="modalDeadline" class="bg-white border-none rounded-xl px-3 py-2 text-xs outline-none shadow-sm">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button id="modalActionBtn" onclick="addTaskFromModal()" class="dynamic-btn text-white flex-1 py-3 rounded-xl text-xs font-bold shadow-lg transition hover:brightness-110">Add to List</button>
                                <button id="cancelEditBtn" onclick="clearInputFields()" class="hidden bg-gray-200 text-gray-500 px-4 py-3 rounded-xl text-xs font-bold shadow-sm transition hover:bg-gray-300">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-white border-t border-gray-50 flex justify-end">
                    <button onclick="saveDayData()" id="saveBtn" class="bg-gray-900 text-white px-8 py-2 rounded-xl font-bold hover:bg-black transition shadow-xl text-sm">Save & Sync</button>
                </div>
            </div>
        </div>

        <!-- ÂÇô‰ªΩ/ÈÇÑÂéüÂΩàÁ™ó -->
        <div id="exportModal" class="fixed inset-0 bg-black/60 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 w-full max-w-lg shadow-2xl border border-gray-100 flex flex-col max-h-[85vh]">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">ÂÖ®Á´ôÂÇô‰ªΩËàáÈÇÑÂéüÁ≥ªÁµ±</h3>
                    <button onclick="document.getElementById('exportModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2.5" stroke-linecap="round"/></svg>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mb-4 leading-relaxed">
                    <b>ÂÇô‰ªΩÔºö</b> Ë§áË£Ω‰∏ãÊñπÊñáÂ≠ó‰∏¶Â¶•ÂñÑ‰øùÂ≠ò„ÄÇ<br>
                    <b>ÈÇÑÂéüÔºö</b> Â∞áÂÇô‰ªΩÊñáÂ≠óË≤ºÂÖ•‰∏ãÊñπÔºåÈªûÊìä„ÄåÈÇÑÂéüÂÖ®Á´ôË≥áÊñô„Äç„ÄÇ
                </p>
                <textarea id="exportArea" class="flex-1 w-full p-4 bg-gray-50 border-none rounded-2xl mb-4 outline-none text-[10px] font-mono shadow-inner border border-gray-100" placeholder="Âú®Ê≠§ËôïË≤º‰∏äÂÇô‰ªΩÊñáÂ≠ó..."></textarea>
                
                <div class="flex flex-col gap-2">
                    <button onclick="copyBackupText()" class="w-full py-3 text-xs font-bold bg-gray-100 text-gray-600 rounded-xl hover:bg-gray-200 transition">Ë§áË£ΩÂÇô‰ªΩ‰ª£Á¢º</button>
                    <div class="flex gap-2">
                        <button onclick="importData()" class="flex-1 py-3 text-xs font-bold bg-blue-500 text-white rounded-xl shadow-lg hover:bg-blue-600 transition">ÈÇÑÂéüÂÖ®Á´ôË≥áÊñô</button>
                        <button onclick="document.getElementById('exportModal').classList.add('hidden')" class="flex-1 py-3 text-xs font-bold bg-gray-900 text-white rounded-xl shadow-lg">ÈóúÈñâË¶ñÁ™ó</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Êõ¥Êñ∞ÂæåÁöÑ Firebase Ë®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyBQ54-vdi5kPa4w8uhGO2DQrKOY_L0duCg",
            authDomain: "yizzyplanner.firebaseapp.com",
            projectId: "yizzyplanner",
            storageBucket: "yizzyplanner.firebasestorage.app",
            messagingSenderId: "270215767860",
            appId: "1:270215767860:web:e5a4db8eafc215bfc02761"
        };

        let app, auth, db, user, appId = "yizzy-planner-v2";
        let allData = JSON.parse(localStorage.getItem('yizzy_backup_data') || '{}'); 
        let currentView = 'calendar';
        let viewDate = new Date();
        let selectedDateStr = "";
        let editingIndex = -1;

        // Âè∞ÁÅ£ÂúãÂÆöÂÅáÊó•Ë≥áÊñô (2024-2026)
        const HOLIDAYS_DATA = {
            "2024-0-1": "ÂÖÉÊó¶", "2024-1-8": "Â∞èÂπ¥Â§ú", "2024-1-9": "Èô§Â§ï", "2024-1-10": "Êò•ÁØÄ", "2024-1-11": "Êò•ÁØÄ", "2024-1-12": "Êò•ÁØÄ", "2024-1-28": "‰∫å‰∫åÂÖ´Á¥ÄÂøµÊó•", "2024-3-4": "ÂÖíÁ´•ÁØÄ", "2024-3-5": "Ê∏ÖÊòéÁØÄ", "2024-5-10": "Á´ØÂçàÁØÄ", "2024-8-17": "‰∏≠ÁßãÁØÄ", "2024-9-10": "ÂúãÊÖ∂Êó•",
            "2025-0-1": "ÂÖÉÊó¶", "2025-0-27": "Â∞èÂπ¥Â§ú", "2025-0-28": "Èô§Â§ï", "2025-0-29": "Êò•ÁØÄ", "2025-0-30": "Êò•ÁØÄ", "2025-0-31": "Êò•ÁØÄ", "2025-1-28": "‰∫å‰∫åÂÖ´Á¥ÄÂøµÊó•", "2025-3-4": "ÂÖíÁ´•ÁØÄ", "2025-3-5": "Ê∏ÖÊòéÁØÄ", "2025-4-31": "Á´ØÂçàÁØÄ", "2025-9-6": "‰∏≠ÁßãÁØÄ", "2025-9-10": "ÂúãÊÖ∂Êó•",
            "2026-0-1": "ÂÖÉÊó¶", "2026-1-16": "Â∞èÂπ¥Â§ú", "2026-1-17": "Èô§Â§ï", "2026-1-18": "Êò•ÁØÄ", "2026-1-19": "Êò•ÁØÄ", "2026-1-20": "Êò•ÁØÄ", "2026-1-28": "‰∫å‰∫åÂÖ´Á¥ÄÂøµÊó•", "2026-3-4": "ÂÖíÁ´•ÁØÄ", "2026-3-5": "Ê∏ÖÊòéÁØÄ", "2026-5-19": "Á´ØÂçàÁØÄ", "2026-8-25": "‰∏≠ÁßãÁØÄ", "2026-9-10": "ÂúãÊÖ∂Êó•"
        };

        const monthNamesEng = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const weekDayEng = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        async function initApp() {
            const loadingStatus = document.getElementById('loadingStatus');
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ÂòóË©¶ÁôªÂÖ•ÔºåËã•Â∞àÊ°àÊú™Ë®≠ÂÆöÂ•ΩÂâáÂøΩÁï•ÈåØË™§ÈÄ≤ÂÖ•Êú¨Âú∞Ê®°Âºè
                await signInAnonymously(auth).catch(err => {
                    console.warn("Firebase Auth Êú™ÂïüÂãïÊàñË®≠ÂÆöÈåØË™§ÔºåÈÄ≤ÂÖ•Êú¨Âú∞ÂÑ≤Â≠òÊ®°Âºè„ÄÇ Error:", err.code);
                    loadingStatus.innerText = "Èõ≤Á´ØÂ∞öÊú™ÂïüÂãïÔºåÈÄ≤ÂÖ•Êú¨Âú∞Ê®°ÂºèÊ®°Âºè...";
                    setTimeout(() => {
                         document.getElementById('loading').style.display = 'none';
                         renderView();
                    }, 1000);
                });

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'mainData');
                        onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                allData = docSnap.data().content || {};
                                localStorage.setItem('yizzy_backup_data', JSON.stringify(allData));
                            }
                            document.getElementById('loading').style.display = 'none';
                            renderView();
                        }, (error) => {
                            console.error("Firestore Áõ£ËÅΩÂ§±Êïó:", error);
                            document.getElementById('loading').style.display = 'none';
                            renderView();
                        });
                    }
                });
            } catch (error) {
                console.error("Firebase ÂàùÂßãÂåñÂ§±Êïó:", error);
                document.getElementById('loading').style.display = 'none';
                renderView();
            }
        }

        function updateYearProgress() {
            const now = new Date();
            const year = now.getFullYear();
            const startOfYear = new Date(year, 0, 1); 
            const diff = now - startOfYear;
            const currentDay = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
            const totalDays = (year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0)) ? 366 : 365;
            document.getElementById('yearProgress').innerText = `Day ${currentDay} / Remaining ${totalDays - currentDay}`;
        }

        function renderMonthlyFocus() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            const listEl = document.getElementById('monthlyFocusList');
            listEl.innerHTML = '';
            
            let pendingItems = [];
            for (let d = 1; d <= 31; d++) {
                const dateStr = `${year}-${month}-${d}`;
                const data = allData[dateStr];
                if (data && data.tasks) {
                    data.tasks.forEach((t) => {
                        if (!t.completed) pendingItems.push({ ...t, date: d, dateStr: dateStr });
                    });
                }
            }

            if (pendingItems.length === 0) {
                listEl.innerHTML = '<p class="text-[10px] text-gray-300 italic py-2">All settled! ‚ú®</p>';
                return;
            }

            pendingItems.sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

            pendingItems.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 group cursor-pointer";
                div.onclick = () => openModal(item.dateStr);
                div.innerHTML = `
                    <div class="w-1.5 h-1.5 rounded-full dynamic-btn flex-shrink-0"></div>
                    <span class="text-[11px] font-bold text-gray-400 w-5 flex-shrink-0">${item.date}</span>
                    <span class="text-[11px] text-gray-600 truncate flex-1">${item.time ? '['+item.time+'] ' : ''}${item.text}</span>
                `;
                listEl.appendChild(div);
            });
        }

        window.switchView = (view) => {
            currentView = view;
            document.getElementById('btnCal').className = view === 'calendar' ? "px-6 py-2 rounded-xl text-xs font-bold transition-all dynamic-btn text-white shadow-md" : "px-6 py-2 rounded-xl text-xs font-bold transition-all text-gray-400 hover:text-gray-600";
            document.getElementById('btnWeek').className = view === 'week' ? "px-6 py-2 rounded-xl text-xs font-bold transition-all dynamic-btn text-white shadow-md" : "px-6 py-2 rounded-xl text-xs font-bold transition-all text-gray-400 hover:text-gray-600";
            document.getElementById('calendarContainer').classList.toggle('hidden', view !== 'calendar');
            document.getElementById('weekContainer').classList.toggle('hidden', view !== 'week');
            renderView();
        }

        window.navigate = (step) => {
            if (currentView === 'calendar') viewDate.setMonth(viewDate.getMonth() + step);
            else viewDate.setDate(viewDate.getDate() + (step * 7));
            renderView();
        }

        window.goToday = () => { viewDate = new Date(); renderView(); }

        function renderView() {
            const month = viewDate.getMonth();
            document.body.className = `p-4 md:p-8 dynamic-bg min-h-screen theme-${month}`;
            document.getElementById('yearLabel').innerText = viewDate.getFullYear();
            updateYearProgress();
            renderMonthlyFocus();
            if (currentView === 'calendar') renderCalendar();
            else renderWeek();
        }

        function renderCalendar() {
            const year = viewDate.getFullYear(), month = viewDate.getMonth();
            document.getElementById('viewTitle').innerText = monthNamesEng[month];
            let firstDay = new Date(year, month, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            for (let i = 0; i < firstDay; i++) container.appendChild(document.createElement('div'));
            
            const tDate = new Date();
            const todayStr = `${tDate.getFullYear()}-${tDate.getMonth()}-${tDate.getDate()}`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${month}-${d}`;
                const holidayName = HOLIDAYS_DATA[dateStr];
                const dayData = allData[dateStr];
                const isToday = dateStr === todayStr;
                const isWeekend = (new Date(year, month, d).getDay() % 6 === 0);

                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day group relative ${isWeekend ? 'bg-gray-100/40' : 'bg-white/50'} hover:bg-white cursor-pointer p-1.5 flex flex-col transition-all rounded-2xl shadow-sm border border-transparent overflow-hidden`;
                if (isToday) dayEl.classList.add('ring-2', 'ring-white', 'dynamic-border', 'bg-white');

                let tasksPreview = '';
                if (dayData && dayData.tasks) {
                    const sortedTasks = [...dayData.tasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                    tasksPreview = sortedTasks.slice(0, 2).map(t => `
                        <div class="task-preview-text ${t.completed ? 'opacity-30' : ''}">
                            <span class="font-bold">${t.time || '‚Ä¢'}</span>
                            <span class="truncate">${t.text}</span>
                        </div>
                    `).join('');
                }

                dayEl.innerHTML = `
                    <div class="flex justify-between items-start mb-0.5">
                        <span class="text-sm font-bold ${holidayName ? 'text-rose-500' : (isToday ? 'dynamic-text' : 'text-gray-600')}">${d}</span>
                        ${dayData && (dayData.tasks?.length > 0) ? '<span class="dot dynamic-btn"></span>' : ''}
                    </div>
                    ${holidayName ? `<div class="holiday-text">${holidayName}</div>` : ''}
                    <div class="mt-1 space-y-0.5">${tasksPreview}</div>
                `;
                dayEl.onclick = () => openModal(dateStr);
                container.appendChild(dayEl);
            }
        }

        function renderWeek() {
            const startOfWeek = new Date(viewDate);
            const dayOffset = startOfWeek.getDay() === 0 ? 6 : startOfWeek.getDay() - 1;
            startOfWeek.setDate(viewDate.getDate() - dayOffset);
            const container = document.getElementById('weekContainer');
            container.innerHTML = '';
            
            const tDate = new Date();
            const todayStr = `${tDate.getFullYear()}-${tDate.getMonth()}-${tDate.getDate()}`;

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateStr = `${day.getFullYear()}-${day.getMonth()}-${day.getDate()}`;
                const holidayName = HOLIDAYS_DATA[dateStr];
                const data = allData[dateStr] || { tasks: [], note: "" };

                const card = document.createElement('div');
                card.className = `bg-white/80 backdrop-blur rounded-[2rem] border p-6 flex flex-col md:flex-row gap-6 transition-all hover:shadow-lg cursor-pointer ${dateStr === todayStr ? 'border-white ring-2 dynamic-border' : 'border-white/50'}`;
                card.onclick = () => openModal(dateStr);

                const sortedTasks = [...(data.tasks || [])].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
                let tasksHtml = sortedTasks.map(t => `
                    <div class="flex items-start gap-3 py-2 border-b border-gray-50 last:border-none">
                        <div class="w-5 h-5 rounded-lg flex-shrink-0 border-2 mt-0.5 flex items-center justify-center ${t.completed ? 'dynamic-btn border-transparent' : 'border-gray-100'}">
                            ${t.completed ? '<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="4" stroke-linecap="round"/></svg>' : ''}
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium ${t.completed ? 'task-done text-gray-300' : 'text-gray-700'}">${t.text}</div>
                            <div class="flex gap-2 mt-0.5">
                                ${t.time ? `<span class="text-[9px] font-bold text-gray-400 bg-gray-50 px-1.5 rounded">üïí ${t.time}</span>` : ''}
                                ${t.deadline ? `<span class="text-[9px] font-bold text-rose-400 bg-rose-50 px-1.5 rounded">üèÅ ${t.deadline}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="flex md:flex-col items-center md:items-start gap-4 md:w-32 flex-shrink-0">
                        <div class="text-[10px] font-black text-gray-300 uppercase tracking-widest">${weekDayEng[day.getDay()].slice(0,3)}</div>
                        <div class="flex flex-col">
                            <div class="text-3xl font-black ${holidayName ? 'text-rose-500' : (dateStr === todayStr ? 'dynamic-text' : 'text-gray-700')}">${day.getDate()}</div>
                            ${holidayName ? `<div class="text-[10px] font-bold text-rose-400 mt-[-4px]">${holidayName}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex-1">${tasksHtml || '<div class="text-gray-200 text-xs italic py-2">Nothing scheduled</div>'}</div>
                `;
                container.appendChild(card);
            }
        }

        window.openModal = (dateStr) => {
            selectedDateStr = dateStr;
            clearInputFields();
            const [y, m, d] = dateStr.split('-');
            const holiday = HOLIDAYS_DATA[dateStr];
            document.getElementById('modalDateTitle').innerText = `${monthNamesEng[m]} ${d}, ${y}${holiday ? ' - ' + holiday : ''}`;
            document.getElementById('modalDayOfWeek').innerText = weekDayEng[new Date(y, m, d).getDay()];
            const data = allData[selectedDateStr] || { tasks: [], note: "" };
            document.getElementById('modalNote').value = data.note || "";
            renderModalTasks(data.tasks || []);
            document.getElementById('dayModal').classList.remove('hidden');
        }

        window.closeModal = () => document.getElementById('dayModal').classList.add('hidden');

        function renderModalTasks(tasks) {
            const list = document.getElementById('modalTaskList');
            list.innerHTML = tasks.length ? '' : '<li class="text-gray-300 text-xs italic text-center py-6">No tasks added</li>';
            
            const sorted = [...tasks].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));
            
            sorted.forEach((task, index) => {
                const originalIndex = tasks.indexOf(task);
                const li = document.createElement('li');
                li.className = `flex items-center justify-between p-4 rounded-2xl group transition-all ${editingIndex === originalIndex ? 'ring-2 dynamic-border bg-white shadow-md' : 'bg-gray-50/50'}`;
                li.innerHTML = `
                    <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="prepareEditTask(${originalIndex})">
                        <div class="w-6 h-6 border-2 rounded-xl flex items-center justify-center transition-all ${task.completed ? 'dynamic-btn border-transparent' : 'border-gray-200 bg-white'}" onclick="event.stopPropagation(); toggleTask(${originalIndex})">
                            ${task.completed ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round"/></svg>' : ''}
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold ${task.completed ? 'task-done text-gray-300' : 'text-gray-600'}">${task.text}</span>
                            <div class="flex gap-2">
                                ${task.time ? `<span class="text-[10px] text-gray-400 font-bold uppercase">Time: ${task.time}</span>` : ''}
                                ${task.deadline ? `<span class="text-[10px] text-rose-300 font-bold uppercase">Due: ${task.deadline}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); deleteTask(${originalIndex})" class="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2"/></svg>
                    </button>`;
                list.appendChild(li);
            });
        }

        window.addTaskFromModal = () => {
            const input = document.getElementById('modalInput');
            const timeInput = document.getElementById('modalTime');
            const deadlineInput = document.getElementById('modalDeadline');

            if (!input.value.trim()) return;
            if (!allData[selectedDateStr]) allData[selectedDateStr] = { tasks: [], note: "" };
            
            const taskObj = { 
                text: input.value, 
                time: timeInput.value || "",
                deadline: deadlineInput.value || "",
                completed: editingIndex > -1 ? allData[selectedDateStr].tasks[editingIndex].completed : false 
            };
            
            if (editingIndex > -1) allData[selectedDateStr].tasks[editingIndex] = taskObj;
            else allData[selectedDateStr].tasks.push(taskObj);
            
            clearInputFields();
            renderModalTasks(allData[selectedDateStr].tasks);
        }

        window.toggleTask = (idx) => {
            allData[selectedDateStr].tasks[idx].completed = !allData[selectedDateStr].tasks[idx].completed;
            renderModalTasks(allData[selectedDateStr].tasks);
        }

        window.deleteTask = (idx) => {
            allData[selectedDateStr].tasks.splice(idx, 1);
            renderModalTasks(allData[selectedDateStr].tasks);
        }

        window.prepareEditTask = (idx) => {
            editingIndex = idx;
            const task = allData[selectedDateStr].tasks[idx];
            document.getElementById('modalInput').value = task.text;
            document.getElementById('modalTime').value = task.time || "";
            document.getElementById('modalDeadline').value = task.deadline || "";
            document.getElementById('modalActionBtn').innerText = "Update Task";
            document.getElementById('inputStatusLabel').innerText = "Editing Item";
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }

        window.clearInputFields = () => {
            editingIndex = -1;
            document.getElementById('modalInput').value = "";
            document.getElementById('modalTime').value = "";
            document.getElementById('modalDeadline').value = "";
            document.getElementById('modalActionBtn').innerText = "Add to List";
            document.getElementById('inputStatusLabel').innerText = "Add Item";
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        window.saveDayData = async () => {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerText = "Saving...";
            if (!allData[selectedDateStr]) allData[selectedDateStr] = { tasks: [], note: "" };
            allData[selectedDateStr].note = document.getElementById('modalNote').value;
            
            localStorage.setItem('yizzy_backup_data', JSON.stringify(allData));
            
            // Âè™ÊúâÂú®ÁôªÂÖ•ÊàêÂäüÁöÑÊÉÖÊ≥Å‰∏ãÊâçÂØ´ÂÖ•Èõ≤Á´Ø
            if (user && db) {
                try {
                    const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'mainData');
                    await setDoc(userDocRef, { content: allData, lastUpdated: new Date() });
                } catch (e) {
                    console.error("Èõ≤Á´ØÂ≠òÊ™îÂ§±Êïó (Ê¨äÈôêÂèØËÉΩÂèóÈôê):", e);
                }
            }
            
            saveBtn.innerText = "Saved!";
            setTimeout(() => { 
                saveBtn.innerText = "Save & Sync"; 
                closeModal(); 
                renderView(); 
            }, 600);
        }

        window.exportData = () => {
            const dataStr = JSON.stringify(allData, null, 2);
            document.getElementById('exportArea').value = dataStr;
            document.getElementById('exportModal').classList.remove('hidden');
        }

        window.copyBackupText = () => {
            const area = document.getElementById('exportArea');
            area.select();
            document.execCommand('copy');
            const btn = event.target;
            btn.innerText = "Â∑≤Ë§áË£ΩÔºÅ";
            setTimeout(() => btn.innerText = "Ë§áË£ΩÂÇô‰ªΩ‰ª£Á¢º", 2000);
        }

        window.importData = async () => {
            const text = document.getElementById('exportArea').value;
            if (!text.trim()) return;
            try {
                const parsed = JSON.parse(text);
                if (confirm("ÈÄôÂ∞áË¶ÜËìãÁèæÊúâÊâÄÊúâË≥áÊñôÔºåÁ¢∫ÂÆöË¶ÅÈÇÑÂéüÂóéÔºü")) {
                    allData = parsed;
                    localStorage.setItem('yizzy_backup_data', JSON.stringify(allData));
                    if (user && db) {
                        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'mainData');
                        await setDoc(userDocRef, { content: allData, lastUpdated: new Date() });
                    }
                    location.reload();
                }
            } catch (e) {
                alert("‰ª£Á¢ºÊ†ºÂºèÈåØË™§ÔºåË´ãÊ™¢Êü•„ÄÇ");
            }
        }

        window.onload = initApp;
    </script>
</body>
</html>
